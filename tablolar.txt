create table account(
	accountId int primary key,
	username varchar unique not null,
	pass varchar not null,
	userType bool not null,
	CONSTRAINT check_pass_length CHECK (LENGTH(pass) > 5 and LENGTH(pass) < 13)
);

create table employer(
	employerId int primary key references account(accountId),
	employerName varchar,
	employerPhone varchar,
	employerAddress varchar,
	CONSTRAINT check_numeric_characters CHECK (employerPhone  ~ '^[0-9]+$')
);

create table employee(
	employeeId int primary key references account(accountId),
	employeeName varchar,
	employeeSurname varchar,
	employeePhone varchar,
	employeeAddress varchar,
	CONSTRAINT check_numeric_characters CHECK (employeePhone  ~ '^[0-9]+$')
);

create table employee_education(
	employeeId int references employee(employeeId),
	schoolName varchar,
	startDate date,
	endDate date,
	schoolType varchar CHECK (schoolType In ('High School','Bachelors','Masters'))
	);
	
create table employee_experience(
	employeeId int references employee(employeeId),
	startDate date,
	endDate date,
	positionName varchar,
	companyName varchar);
	
create table applications(
	employerId int references employer(employerId),
	applicationId int primary key,
	counter int,
	applicationName varchar,
	applicationDate date,
	contractType varchar CHECK (contractType In ('Part Time','Full Time','Intern')),
	positionName varchar,
	description varchar,
	isActive bool
	);

create table appliedApplications(
	employeeId int references employee(employeeId),
	applicationId int references applications(applicationId),
	status varchar CHECK (status In ('waiting','rejected','approved','canceled')),
	coverLetter varchar,
	applicationDate date
);

CREATE VIEW applicationView AS
SELECT
	aa.employeeId,
    app.applicationId,
    employer.employerName,
    app.counter,
    app.applicationName,
    app.applicationDate,
    app.contractType,
    app.positionName,
    app.description,
    aa.status,
    aa.coverLetter,
    aa.applicationDate AS appliedApplicationDate
FROM
    applications app
JOIN
    appliedApplications aa ON app.applicationId = aa.applicationId
join employer on employer.employerId = app.employerId;

CREATE VIEW applicantsView AS
SELECT
	aa.employeeId,
	aa.applicationId,
	aa.status,
	aa.coverLetter,
	aa.applicationDate,
	emp.employeeName,
	emp.employeeSurname,
	emp.employeePhone,
	emp.employeeAddress
FROM
    employee emp
JOIN
    appliedApplications aa ON emp.employeeId = aa.employeeId;


	
CREATE OR REPLACE FUNCTION createAccountFunction()
RETURNS TRIGGER AS $$
BEGIN
	case new.userType 
	   when False then insert into employer values(new.accountId,null,null,null);
	   when True then insert into employee values(new.accountId,null,null,null,null);
	 
   	end case;

   RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER createAccountTrigger
AFTER INSERT ON account
FOR EACH ROW
WHEN (NEW.accountId IS NOT NULL)
EXECUTE FUNCTION createAccountFunction();


CREATE OR REPLACE FUNCTION increaseAdvertisementCounterFunction()
RETURNS TRIGGER AS $$
BEGIN
	update applications as adv set counter = counter + 1 where new.applicationId = adv.applicationId;

   RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER increaseAdvertisementCounterTrigger
AFTER INSERT ON appliedApplications
FOR EACH ROW
WHEN (NEW.applicationId IS NOT NULL)
EXECUTE FUNCTION increaseAdvertisementCounterFunction();

create sequence accountIdGenerator start with 1 increment by 1 no cycle;
create sequence advertisementIdGenerator start with 1 increment by 1 no cycle;

create  type loginCheckType as (userType varchar, accountidd int);

CREATE OR REPLACE FUNCTION loginCheck(funcUsername varchar, funcPassword varchar)
RETURNS loginCheckType as $$

DECLARE 
loginInfo loginCheckType;
counter int :=0;
accountCheck cursor for select username,pass,userType,accountid from account ;
begin
    loginInfo.userType:='No such user';
	loginInfo.accountidd := -1;
    FOR account_row in accountCheck LOOP
    if(account_row.username=funcUsername and account_row.pass=funcPassword) THEN
        loginInfo.accountidd=account_row.accountid ;
        IF(account_row.userType = true) then
            loginInfo.userType='Employee';
        ELSE 
            loginInfo.userType='Employer';
        END IF ;
    END IF;
    END LOOP;
    return loginInfo;
END;
$$ LANGUAGE 'plpgsql';

CREATE OR REPLACE FUNCTION deleteApplication(funcApplicationId int) 
returns void as $$
BEGIN
	UPDATE applications
	SET isActive = false
	WHERE applicationId = funcApplicationId;

	UPDATE appliedApplications
	SET status = 'canceled'
	WHERE applicationId = funcApplicationId;
	
END;
$$ LANGUAGE 'plpgsql';

CREATE OR REPLACE FUNCTION checkExistanceEducation(employeeId int,schoolname varchar,startdate date,enddate date,schooltype varchar)
returns bool as $$
DECLARE 
isExist bool;
exist_cursor CURSOR FOR SELECT * from employee_education;
BEGIN 
	isExist := false;
	FOR row_cursor in exist_cursor LOOP
		IF(employeeId = row_cursor.employeeId and schoolname = row_cursor.schoolname and startdate = row_cursor.startdate and enddate = row_cursor.enddate and schooltype = row_cursor.schooltype) THEN
			isExist := true;
		END IF;	
	END LOOP;
	RETURN isExist;
END;
$$ LANGUAGE 'plpgsql';
	


CREATE OR REPLACE FUNCTION checkExistanceExperience(employeeId int, startdate date, enddate date, positionname varchar, companyname varchar)
returns bool as $$
DECLARE 
isExist bool;
exist_cursor CURSOR FOR SELECT * from employee_experience;
BEGIN 
	isExist := false;
	FOR row_cursor in exist_cursor LOOP
		IF(employeeId = row_cursor.employeeId  and startdate = row_cursor.startdate and enddate = row_cursor.enddate and positionname = row_cursor.positionname and row_cursor.companyname = companyname) THEN
			isExist := true;
		END IF;	
	END LOOP;
	RETURN isExist;
END;
$$ LANGUAGE 'plpgsql';
